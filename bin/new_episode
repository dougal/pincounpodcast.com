#!/usr/bin/env ruby

require 'date'
require 'pathname'
require 'digest'

begin
  require 'liquid'
rescue LoadError
  puts "You do not have the `liquid` gem installed"
  puts ""
  puts "Install with: gem install liquid"
  puts ""
  puts "You may be required to use sudo to install"
  exit(1)
end

episode_parent_dir = Pathname.new('episodes')

# Find the last episode.
last_episode_entry = episode_parent_dir.entries.last

# Work out what the new episode should be.
if last_episode_entry.to_s[/^\./] # Is a system directory
  episode_number = 1
else
  episode_number = last_episode_entry.to_s.to_i + 1
end

# Create a directory.
episode_path = episode_parent_dir.join(episode_number.to_s)
puts "Creating directory #{episode_path}"
episode_path.mkdir

# Create a metadata file.
template     = Liquid::Template.parse(File.read('templates/blank_episode.md.liquid'), :error_mode => :strict)
output_path  = episode_path.join("shownotes.md")
episode_date = DateTime.now.iso8601
guid         = Digest::SHA256.hexdigest "#{episode_date}#{episode_number}"

puts "Writing shownotes file #{output_path}"
output_path.open('w+') do |f|
  f.write template.render('episode_number' => episode_number,
                          'episode_date' => episode_date,
                          'episode_guid' => guid)
end

puts "Creating new Git branch for episode..."
`git checkout -b episode-#{episode_number}`

puts "Committing shownotes file..."
`git add #{output_path}`
`git commit -m "Adding generated shownotes file for episode #{episode_number}"`

puts "Done."
